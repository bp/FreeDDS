<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>Data Dictionary System: Developers "C" Templates (Template 2)</title>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
    <meta name="keywords" 
      content="Data Dictionary System Free Seismic Processing System">
    <link href="../../styles.css" type="text/css" rel="stylesheet">
    <script src="../../javascript.js" language="JavaScript"
      type="text/javascript"></script>
    <script type="text/javascript">
      if (location.search.search("remove=") >= 0) {
         var tmp = "position:absolute;left:-9999px;";
      } else {
         var tmp = "";
      }
      document.write("<style type='text/css'>.comment "
         +"{color:#c00000;"+tmp+"}<\/style>");

      function setRemoveOption() {
         var tmp;
         if (location.search.search("remove=") >= 0) {
            tmp = "'Add Tutorial Comments'";
         } else {
            tmp = "'Remove Tutorial Comments'";
         }
         document.write("<center><form><input type='button' value="
            +tmp+" onclick='toggleComments();'><\/form><\/center>");
      }      
         
      function toggleComments() {
         if (location.search.search("remove=") >= 0) {
            document.location.search = "";
         } else {
            location = "?remove=";
         }
      }
    </script>
    <style type="text/css">
      pre {color:#000000;}
    </style>  
  </head>
  <body>
    <script type="text/javascript">
      header("developers","ctemplates","c_template2")
    </script>
    <!*********************************************************************>

    <script type="text/javascript">setRemoveOption();</script>

    <pre>
/***********************************************************************
                   B P   A M E R I C A  
           PROPRIETARY - TO BE MAINTAINED IN CONFIDENCE 
                         COPYRIGHTED 2006
 ***********************************************************************

                           TEMPLATE 2

     <b>FORTRAN TEMPLATE DEMONSTRATING THE USE OF DDS CONVENIENCE </b>
     <b>ROUTINES FOR A SIMPLE TRACE-TO-TRACE PROCESSING SCHEME </b>
     <b>WITHOUT USING OR PASSING ANY TRACE HEADERS.</b>

     Use a file extension of ".F" instead of ".f" to pull in the 
     compiler preprocessor.

     Written by Jerry Ehlers November 2006

 **********************************************************************/

#define _POSIX_SOURCE 1    /* Check POSIX Standard            */
#define ANSI               /* Turn on prototyping from cdds.h */

#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
#include &lt;math.h&gt;
<span class="comment">/*
   INCLUDE THE DDS API (Application Program Interface)
 */</span>
#include &lt;cdds.h&gt;           /* "C" dds include */

#define RCSID "$Id: c_template2.html 1 2009-01-06 00:31:13Z ehlersjw $"
#define TITLE "template2: C template using DDS convenience routines"

void doit(int, int, int, float, float*);

/***********************************************************************
 *
 * main
 *
 **********************************************************************/
int main(int argc, char **argv)
{
   BIN_TAG in_bin=-1, out_bin=-1;
   int ier, ns;
   float scale, *buf;
   char *prog;

   /***********************************************************************
    *    initialize
    **********************************************************************/
   /*
    * get the program name
    */
   prog = strrchr(argv[0], '/');
   if (prog) prog++;
   else prog = argv[0];

   /*
    * pass the command line arguments on to DDS
    */
   setargcv(argc, argv);
   <span class="comment">/*
      OPEN THE PRINT FILE &amp; CHECK FOR HELP 
      'cdds_openpr' function:
           Open a printfile using the information automatically 
           generated by RCS in '$Id: c_template2.html 1 2009-01-06 00:31:13Z ehlersjw $'.  If the user specifies some
           form of help (-h help= HELP=...) on the command line,
           then the return value will be &lt; 0.
    */</span>
   ier = <a href="../capi/openpr.html">cdds_openpr</a>(prog, RCSID);
   if (ier &gt; 0) help();

   /***********************************************************************
    *    open input data file
    **********************************************************************/
   <span class="comment">/*    
      OPEN THE INPUT DATASET 
      'cddx_in' function:
           This function opens the input file, with data Samples only 
           as real values (unless input is complex).
    */</span>
   in_bin = <a href="../cxapi/in.html">cddx_in</a>("in", "stdin:", TITLE);
   <span class="comment">/*
      PRINT ERROR MESSAGE
      'cdds_prterr' function:
           Print an error message to the console (&amp; printfile if 
           exists). Error count is kept by DDS.  Check for errors later,  
           before processing to check for as many things as possible first.
    */</span>
   if (in_bin &lt; 0) {
      <a href="../capi/prterr.html">cdds_prterr</a>("Unable to open input data\n");
   }
   <span class="comment">/*
      RETRIEVE DATASET DEFINITIONS NEEDED BY APPLICATION 
      'cdds_scanf' function:
           Default values are assigned prior to definition retrieval.
           A variable are unchanged, if it is not specified.

           NOTE: What's special about the "size.axis(1)" definition?
           'axis(N)' is automatically converted to the Nth axis name.
           This allows hyper cube attributes to be retrieved by axis
           number, instead of axis name.  For example, "size.axis(1)"
           becomes "size.t" (assuming "axis=  t x y").

           WARNING: Do NOT use %i, use %d to scan for integers because
                    %i will interpret a value with a leading "0" as 
                    octal instead decimal (eg. 010 would be read as
                    8 instead of 10).
    */</span>
   /*
    *    Get input data parameters
    */
   <a href="../capi/scanf.html">cdds_scanf</a>("size.axis(1)", "%d", &amp;ns);

   /***********************************************************************
    *    read parameters
    **********************************************************************/
   <span class="comment">/*
      RETRIEVE COMMAND LINE PARAMETERS
      'cdds_dict' function:
           'cdds_dict' selects the 'par:' dictionary for scanning.
           This dictionary only contains definitions from the command
           line, and parameter dictionaries ("par=  fn1  fn2 ...").
           Parameters ("in= ", "out_format= ", etc.) for the current
           process can be read, without ambiguity from the input history 
           (ie. local parameters only).
    */</span>
   <a href="../capi/dict.html">cdds_dict</a>("par:", "scan");

   /*
    * get scale parameter (default 1.0)
    */
   scale = 1.0;
   <a href="../.capi/scanf.html">cdds_scanf</a>("scale", "%f", &amp;scale);

   /***********************************************************************
    *    print user parameters
    **********************************************************************/
   <span class="comment">/*
      PRINT MESSAGES 
      'cdds_prtmsg' function:
           This function prints a formatted message to the print file
           opened by "cdds_openpr"; otherwise to the console (stderr).

      'cdds_prtcon' function:
           This function prints a formatted message to the console and
           to the print file if opened.
   
      'cdds_prtmsg' function:
           This function prints a formatted error message to the console 
           and to the print file if opened.  It also keeps track of the
           number of error messages printed for "cdds_closepr".
    */</span>
   <a href="../capi/prtmsg.html">cdds_prtmsg</a>("\n*** USER PARAMETERS ***\n\n");
   <a href="../capi/prtmsg.html">cdds_prtmsg</a>("\tscale = %g\n", scale);
   <a href="../capi/prtmsg.html">cdds_prtmsg</a>("\n");

   /*
    * Check parameters
    */
   if (scale &lt; 0.0) {
      <a href="../capi/prtcon.html">cdds_prtcon</a>("WARNING: \"scale\" is negative!\n");
   }

   /***********************************************************************
    *    allocate dynamic arrays
    **********************************************************************/
   <span class="comment">/*
      Don't allocate arrays if there are already any errors; 
      we could have bad array sizes
    */</span> 
   if (cdds_errors()) goto finish;
   <span class="comment">/*
      ALLOCATE DYNAMIC ARRAYS 
      'cdds_malloc' function:
           This function allocates memory or reports an error &amp; aborts.
           Storage can be released by calling "cdds_free".  Use 
           "dds_debug= dbg_call" will cause DDS to check memory at
           each api call.
   */</span>
   /*
    * Allocate memory for a single trace 
    */
   buf = <a href="../capi/malloc.html">cdds_malloc</a>(ns * sizeof(float));

   /***********************************************************************
    *    open output dataset
    **********************************************************************/
   <span class="comment">/*
      CHECK FOR ERRORS BEFORE PROCEEDING ANY FURTHER 
      'cdds_errors' function:
           This function returns the number of errors reported using
           "cdds_prterr".  No reason to create a new output if there
           have been any errors.
    */</span>
   if (<a href="../capi/errors.html">cdds_errors</a>()) goto finish;
   <span class="comment">/*
      CREATE OUTPUT FROM INPUT DICTIONARY 
      'cddx_out' function:
           This function will create an output dataset from the input
           binary, passing all it's history information along.  
           The user can override the output format and binary data by 
           defining "out_format=" or "out_data=" since the first
           argument is 'out'.

           With the output convenience routines, the binaries are not 
           actually opened until the binary tag is first used for I/O. 
           This way the internal buffer definitions for the output file
           can be redefined (eg. axis, size, delta, origin...).  So no
           need to check out_bin until after it really gets opened.
    */</span>
   out_bin = <a href="../cxapi/out.html">cddx_out</a>("out", "stdout:", TITLE, in_bin);
   <span class="comment">/*
      FORCE OPEN THE OUTPUT BINARIES
      'cdds_lseek' function:
          This function seeks to a specific trace position.  It is used 
          here simply to force open the internal and output binaries.
          Now we can check if it was really opened.
    */</span>
   ier = <a href="../capi/lseek.html">cdds_lseek</a>(out_bin, 0, 0, SEEK_SET);
   if (ier &lt; 0) {
      <a href="../capi/prterr.html">cdds_prterr</a>("Unable to open output dataset!\n");
   }

   /***********************************************************************
    *    process the data
    **********************************************************************/

   if (<a href="../capi/errors.html">cdds_errors</a>()) goto finish;

   doit(in_bin, out_bin, ns, scale, buf);

   /***********************************************************************
    *    close files, clean-up, &amp; exit
    **********************************************************************/
   <span class="comment">/*
      CLOSE OUT
      'cdds_close' function:
           This function closes a dataset if the binary tag is &gt;= 0
           including all underlying dictionaries and data structures.
           This will also flush out all DDS data buffers out to the
           kernel.

      'cdds_closepr' function:
           This function will close out the print file (if opened)
           adding diagnosti  information, unread command line 
           parameters and termination status.  It will also exit
           the program giving a usable status code.
    */</span>
finish:
   <a href="../capi/close.html">cdds_close</a>(in_bin);
   <a href="../capi/close.html">cdds_close</a>(out_bin);

   <a href="../capi/closepr.html">cdds_closepr</a>();
}

/***********************************************************************
 * 
 *		doit
 *
 **********************************************************************/
void doit(int in_bin, int out_bin, int ns, float scale, float* buf)
{
   int ier, i;

   /*
    * loop over each trace
    */
   <span class="comment">/*
         READ DATA
         'cddx_read' function:
              This function reads a specified number of traces mapping
              each into the input buffer.  
              Check the number read in case of any problems.
    */</span>
   ier = <a href="../cxapi/read.html">cddx_read</a>(in_bin, buf, 1);
   while(ier == 1) {
      /*
       * process the trace
       */
      for(i=0;i&lt;ns;i++) buf[i] = scale * buf[i];
  
      /*
       * write the trace
       */
      <span class="comment">/*
            WRITE DATA
            'cddx_write' function:
                 This function maps a specified number of traces from the
                 buffer and writes them out.  
                 Check the number written in case of any problems.
       */</span>
      ier = <a href="../cxapi/write.html">cddx_write</a>(out_bin, buf, 1);
      if (ier != 1) {
         <a href="../capi/prterr.html">cdds_prterr</a>("writing output\n");
         return;
      }

      /*
       *  read the next trace
       */
      ier = <a href="../cxapi/read.html">cddx_read</a>(in_bin, buf, 1);
   }
   
   return;
}
      
/***********************************************************************
 * 
 *		help
 *
 **********************************************************************/
void help()
{
   fprintf(stderr, "Template program demonstrating the simple use of DDS\n");
   fprintf(stderr, "convenience routines for a simple trace-to-trace processing\n");
   fprintf(stderr, "scheme without using or passing any trace headers.\n");
   fprintf(stderr, "\n");
   fprintf(stderr, "usage:\n");
   fprintf(stderr, "   c_template2 [in=dat] [in_data=bin] [in_format=fmt] \\\n");
   fprintf(stderr, "   [out=dat] [out_data=bin] [out_format=fmt] \\\n");
   fprintf(stderr, "   [scale=f]\n");
   fprintf(stderr, "   \n");
   fprintf(stderr, "where:\n");
   fprintf(stderr, "   in=        input dataset\n");
   fprintf(stderr, "   in_data=   input binary\n");
   fprintf(stderr, "   in_format= input format\n");
   fprintf(stderr, "   out=       output dictionary\n");
   fprintf(stderr, "   out_data=  output binary\n");
   fprintf(stderr, "   out_format=output format\n");
   fprintf(stderr, "   scale=     scale factor (dflt=1.0)\n");
   fprintf(stderr, "\n");

   exit(0);
}
    </pre>

    <!*********************************************************************>
    <script type="text/javascript">footer()</script>
  </body>
</html>
